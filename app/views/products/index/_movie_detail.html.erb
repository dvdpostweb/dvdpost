<% if movie_detail %>
<% product = movie_detail %>
<% path = product_path(:id => product.to_param, :recommendation => @source) %>
<% if product.streaming? %>
  <% @token = current_customer ? current_customer.get_token(product.imdb_id) : nil %>
<% end %>
<div class="<%= jacket_mode == :streaming || product.vod? ? 'vod' : product_media_id(product.media) %> clearfix">
<% view = params[:view_mode] == 'streaming' ? 0 : 1 %>
<% name = "#{I18n.locale}/products/product_#{ENV['HOST_OK']}_#{view}_#{product.id}" %>
<% name_path = "views//#{name}" %>
<% if product.cached_at && product.products_last_modified && product.cached_at < product.products_last_modified %>
  <% expire_fragment(product) %>
<% end %>
<% unless Rails.cache.exist? name_path %>
  <% product.update_attributes(:cached_at => Time.now.to_s(:db)) %>
<% end %>

<% cache name do %>
<% data = product.description_data(true) %>
<% product_title = data[:title] %>
<% product_image = data[:image] %>
<% product_description =  data[:description] %>
  <div class="movie-descr">
    <h2>
      <%= link_to product_title, path %>
    </h2>
    <p>
      <%= truncate_html(product_description.text, :length => 300) %>
      <%= bubbles(product) %>
    </p>
    <p class="links">
      <% if product.trailer %>
        <%= link_to(t('.trailer'), product_trailer_path(:product_id => product.to_param), :class => 'trailer', :target => :_blank) %>
        <%= content_tag(:span, image_tag('delimiter.gif')) if (!product_description.url.nil? && !product_description.url.empty?) %>
      <% end %>
      <%= link_to(t('.more'), path, :class => 'more') %>
    </p>
  </div>
  <div class="movie-info">
    <div class="subs">
      <%= image_tag product.public.image, :alt => product.public.description if product.public %>
      <div style='clear:left'></div>
    </div>
    <% if product.actors.count > 0  %>
    <div class="cast">
      <h3>
        <%= t '.actors' %>
      </h3>
      <p><%= product.actors.limit(8).collect{|actor| link_to actor.name, actor_products_path(:actor_id => actor.to_param)}.join(', ') %></p>
    </div>
    <% end %>
    <% if product.director %>
      <h3>
        <%= t '.director' %>
      </h3>
      <p><%= link_to product.director.name, director_products_path(:director_id => product.director.to_param) %></p>
    <% end %>
    <% if product.studio %>
      <h3>
        <%= t '.studio' %>
      </h3>
      <p><%= link_to product.studio.name, studio_products_path(:studio_id => product.studio.to_param) %></p>
    <% end %>
    
  </div>
  <div>
    <% link_to path, :class => :cover, :title => product_title do %>
      <%= product_image_tag product_image, :width => 62, :height => 95 %>
    <% end %>
  </div>
  <% end %>
  <div class="action">
    <h4>
      <% if @category %>
        <%= @category.name %>
      <% else %>
        <% if product.adult? %>  
          <%= product.categories.first.name unless product.categories.empty? %>
        <% else %>
          <%= product.categories.active.first.name unless product.categories.active.empty? %>
        <% end %>
      <% end %>
    </h4>
    <div class="stars" id="rating-stars-<%= product.to_param %>" product_id="<%= product.to_param %>">
      <%= render :partial => 'products/rating', :locals => {:product => product, :background => rating_color} %>
    </div>
    <% if current_customer %>
    <div class="links" id="seen-uninterested-<%= product.to_param %>">
      <%= render :partial => 'products/show/seen_uninterested', :locals => {:product => product} %>
    </div>
    <% end %>
    <%= render :partial => 'products/wishlist', :locals => {:product => product, :text => :long, :source => @source} unless params[:view_mode] == 'streaming' || params[:view_mode] == 'popular_streaming' || params[:view_mode] == 'weekly_streaming' %>
    <% if product.streaming? && streaming_access? %>
      <%= render :partial => 'products/streaming', :locals => {:product => product, :token => @token } %>
      <%= render :partial => 'products/vod_list', :locals => {:product => product} %>
    <% elsif product.in_streaming_or_soon? && streaming_access? && product.vod_next %>
      <%= render :partial => 'products/streaming_soon' %>
    <% end %>
  </div>
  
</div>

<% end %>